<div class="container mt-4">

  <!-- üèÜ ENCABEZADO DEL TORNEO -->
  <div class="card shadow-sm mb-4 border-0">
    <div class="card-body">
      <h3 class="text-center text-primary fw-bold mb-4">
        Torneo: {{ selectedTournament?.name || '---' }}
      </h3>

      <div class="row g-4">
        <div class="col-md-6">
          <p><i class="fas fa-user text-primary me-2"></i><strong>Organizador:</strong> {{ selectedTournament?.organizer
            || '-' }}</p>
          <p><i class="fas fa-map-marker-alt text-danger me-2"></i><strong>Ubicaci√≥n:</strong> {{
            selectedTournament?.location || '-' }}</p>
          <p><i class="fas fa-globe text-info me-2"></i><strong>√Åmbito:</strong> {{ selectedTournament?.ambitName }}</p>
        </div>
        <div class="col-md-6">
          <p><i class="fas fa-calendar-alt text-warning me-2"></i><strong>Fecha Inicio:</strong> {{
            selectedTournament?.startDate | date:'dd/MM/yyyy' }}</p>
          <p><i class="fas fa-calendar-check text-success me-2"></i><strong>Fecha Fin:</strong> {{
            selectedTournament?.endDate | date:'dd/MM/yyyy' }}</p>
          <p><i class="fas fa-info-circle text-secondary me-2"></i><strong>Estado:</strong>
            <span class="badge" [ngClass]="selectedTournament?.status ? 'text-bg-success' : 'text-bg-secondary'">
              {{ selectedTournament?.status ? 'Activo' : 'Inactivo' }}
            </span>
          </p>
        </div>
      </div>
    </div>
  </div>

  <!-- üë• JUGADORES INSCRITOS -->
  <div class="card shadow-sm mb-4 border-0">
    <div class="card-body">
      <div class="d-flex justify-content-between align-items-center mb-4">
        <h5 class="fw-bold text-secondary mb-0">Jugadores del Torneo</h5>
        <div>
          <button class="btn btn-outline-primary btn-sm me-2">
            <i class="fas fa-file-excel me-1"></i> Cargar jugadores
          </button>
          <button class="btn btn-success btn-sm" (click)="openModal(modalPlayerRef)">
            <i class="fas fa-plus-circle me-1"></i> Nuevo Jugador
          </button>
        </div>
      </div>

      <!-- Tabla jugadores -->
      <div class="table-responsive">
        <table class="table table-hover table-sm align-middle text-center border">
          <thead class="table-light">
            <tr class="fw-bold">
              <th>#</th>
              <th>Nombre</th>
              <th>Categor√≠a</th>
              <th>Modalidad</th>
              <th>Rama</th>
              <th>Equipo</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let p of registrations; let i = index">
              <td>{{ i + 1 }}</td>
              <td>{{ p.personFullName || '-' }}</td>
              <td>{{ p.categoryName || '-' }}</td>
              <td>{{ p.modalityName || '-' }}</td>
              <td>{{ p.branchName || '-' }}</td>
              <td>{{ p.teamName || 'N/A' }}</td>
              <td>
                <div class="d-flex justify-content-center gap-2">
                  <button class="btn btn-outline-primary btn-sm" (click)="editPlayer(p)">
                    <i class="fas fa-edit"></i>
                  </button>
                  <button class="btn btn-outline-danger btn-sm" (click)="deletePlayer(p.registrationId)">
                    <i class="fas fa-trash"></i>
                  </button>
                </div>
              </td>
            </tr>
            <tr *ngIf="!registrations?.length">
              <td colspan="7" class="text-muted py-3">No hay jugadores cargados.</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- üéØ RESULTADOS -->
  <div class="card shadow-sm border-0">
    <div class="card-body">
      <div class="d-flex justify-content-between align-items-center mb-4">
        <h5 class="fw-bold text-secondary mb-0">Resultados del Torneo</h5>
        <div>
          <button class="btn btn-outline-primary btn-sm me-2">
            <i class="fas fa-file-excel me-1"></i> Cargar Resultados
          </button>
          <button class="btn btn-success btn-sm" (click)="openModal(modalResultRef)">
            <i class="fas fa-plus-circle me-1"></i> Nuevo Resultado
          </button>
        </div>
      </div>

      <!-- Filtros -->
      <div class="row g-3 mb-3">
        <div class="col-md-4">
          <label class="form-label">Categor√≠a</label>
          <select class="form-select form-select-sm" [(ngModel)]="selectedCategory" (change)="onFilterChange()">
            <option value="">Todas</option>
            <option *ngFor="let c of categories" [value]="c.categoryId">{{ c.name }}</option>
          </select>
        </div>
        <div class="col-md-4">
          <label class="form-label">Modalidad</label>
          <select class="form-select form-select-sm" [(ngModel)]="selectedModality" (change)="onFilterChange()">
            <option value="">Todas</option>
            <option *ngFor="let m of modalities" [value]="m.modalityId">{{ m.name }}</option>
          </select>
        </div>
        <div class="col-md-4">
          <label class="form-label">Rama</label>
          <select class="form-select form-select-sm" [(ngModel)]="selectedBranch" (change)="onFilterChange()">
            <option value="">Todas</option>
            <option value="Masculina">Masculina</option>
            <option value="Femenina">Femenina</option>
            <option value="Mixta">Mixta</option>
          </select>
        </div>
      </div>

      <!-- Tabla resultados -->
      <div class="table-responsive">
        <table class="table table-hover table-sm align-middle text-center border">
          <thead class="table-light">
            <tr class="fw-bold">
              <th>ID</th>
              <th>Torneo</th>
              <th>Categor√≠a</th>
              <th>Modalidad</th>
              <th>Rama</th>
              <th>Ronda</th>
              <th>Jugador</th>
              <th>Equipo</th>
              <th>Pista</th>
              <th>L√≠nea Jugada</th>
              <th>Puntaje</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let result of filteredResults">
              <td>{{ result.resultId }}</td>
              <td>{{ result.tournamentName || selectedTournament?.name || '-' }}</td>
              <td>{{ result.categoryName || '-' }}</td>
              <td>{{ result.modalityName || '-' }}</td>
              <td>{{ result.branch || '-' }}</td>
              <td>{{ result.roundNumber || '-' }}</td>
              <td>{{ result.personName || '-' }}</td>
              <td>{{ result.teamName || '-' }}</td>
              <td>{{ result.laneNumber || '-' }}</td>
              <td>{{ result.lineNumber || '-' }}</td>
              <td>{{ result.score || '-' }}</td>
              <td>
                <div class="d-flex justify-content-center gap-2">
                  <button class="btn btn-outline-primary btn-sm" (click)="editResult(result)">
                    <i class="fas fa-edit"></i>
                  </button>
                  <button class="btn btn-outline-danger btn-sm" (click)="deleteResult(result.resultId)">
                    <i class="fas fa-trash"></i>
                  </button>
                </div>
              </td>
            </tr>
            <tr *ngIf="!filteredResults?.length">
              <td colspan="12" class="text-muted py-3">No hay resultados disponibles.</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

</div>


<!-- Modal: Nuevo Resultado --> <ng-template #modalResult>
  <div class="modal-content">
    <div class="modal-header">
      <h5 class="modal-title">Nuevo Resultado</h5> <button type="button" class="btn-close" aria-label="Close"
        (click)="closeModal()"></button>
    </div>
    <div class="modal-body"> <!-- Form de ejemplo -->
      <div class="row g-3">
        <div class="col-md-6"> <label class="form-label">Jugador</label> <input class="form-control form-control-sm"
            placeholder="Nombre del jugador" /> </div>
        <div class="col-md-3"> <label class="form-label">Ronda</label> <input type="number"
            class="form-control form-control-sm" /> </div>
        <div class="col-md-3"> <label class="form-label">Puntaje</label> <input type="number"
            class="form-control form-control-sm" /> </div>
      </div>
    </div>
    <div class="modal-footer"> <button class="btn btn-secondary btn-sm" (click)="closeModal()">Cancelar</button> <button
        class="btn btn-primary btn-sm">Guardar</button> </div>
  </div>

</ng-template>

<!-- Modal: Nuevo Jugador -->
<ng-template #modalPlayer>
  <div class="modal-content">
    <div class="modal-header bg-primary text-white">
      <h5 class="modal-title">{{ idPlayer ? 'Editar' : 'Nuevo' }} Jugador</h5> <button type="button"
        class="btn-close btn-close-white" aria-label="Close" (click)="closeModal()"></button>
    </div>
    <form [formGroup]="playerForm" (ngSubmit)="savePlayer()">
      <div class="modal-body">
        <div class="row g-3"> <!-- Persona -->
          <div class="col-md-6"> <label class="form-label">Persona *</label> <select class="form-select form-select-sm"
              formControlName="personId"
              [ngClass]="{ 'is-invalid': playerForm.controls['personId'].invalid && playerForm.controls['personId'].touched, 'is-valid': playerForm.controls['personId'].valid }">
              <option [ngValue]="null" disabled>Seleccione persona</option>
              <option *ngFor="let player of players" [ngValue]="player.personId"> {{ player.fullName }} {{
                player.fullSurname }} </option>
            </select>
            <div class="invalid-feedback"
              *ngIf="playerForm.controls['personId'].invalid && playerForm.controls['personId'].touched"> Debe
              seleccionar una persona. </div>
          </div> <!-- Categor√≠a -->
          <div class="col-md-6"> <label class="form-label">Categor√≠a *</label> <select
              class="form-select form-select-sm" formControlName="categoryId"
              [ngClass]="{ 'is-invalid': playerForm.controls['categoryId'].invalid && playerForm.controls['categoryId'].touched, 'is-valid': playerForm.controls['categoryId'].valid }">
              <option [ngValue]="null" disabled>Seleccione categor√≠a</option>
              <option *ngFor="let cat of selectedTournament?.categories" [ngValue]="cat.categoryId"> {{ cat.name }}
              </option>
            </select>
            <div class="invalid-feedback"
              *ngIf="playerForm.controls['categoryId'].invalid && playerForm.controls['categoryId'].touched"> Debe
              seleccionar una categor√≠a. </div>
          </div> <!-- Modalidad -->
          <div class="col-md-6"> <label class="form-label">Modalidad *</label> <select
              class="form-select form-select-sm" formControlName="modalityId"
              [ngClass]="{ 'is-invalid': playerForm.controls['modalityId'].invalid && playerForm.controls['modalityId'].touched, 'is-valid': playerForm.controls['modalityId'].valid }">
              <option [ngValue]="null" disabled>Seleccione modalidad</option>
              <option *ngFor="let mod of selectedTournament?.modalities" [ngValue]="mod.modalityId"> {{ mod.name }}
              </option>
            </select>
            <div class="invalid-feedback"
              *ngIf="playerForm.controls['modalityId'].invalid && playerForm.controls['modalityId'].touched"> Debe
              seleccionar una modalidad. </div>
          </div> <!-- Rama -->
          <div class="col-md-6"> <label class="form-label">Rama *</label> <select class="form-select form-select-sm"
              formControlName="branchId"
              [ngClass]="{ 'is-invalid': playerForm.controls['branchId'].invalid && playerForm.controls['branchId'].touched, 'is-valid': playerForm.controls['branchId'].valid }">
              <option [ngValue]="null" disabled>Seleccione rama</option>
              <option *ngFor="let branch of selectedTournament?.branches" [ngValue]="branch.branchId"> {{ branch.name }}
              </option>
            </select>
            <div class="invalid-feedback"
              *ngIf="playerForm.controls['branchId'].invalid && playerForm.controls['branchId'].touched"> Debe
              seleccionar una rama. </div>
          </div> <!-- Equipo -->
          <!-- <div class="col-md-6"> <label class="form-label">Equipo *</label> <select class="form-select form-select-sm" formControlName="teamId" [ngClass]="{ 'is-invalid': playerForm.controls['teamId'].invalid && playerForm.controls['teamId'].touched, 'is-valid': playerForm.controls['teamId'].valid }"> <option [ngValue]="null" disabled>Seleccione equipo</option> <option *ngFor="let team of teams" [ngValue]="team.teamId">{{ team.name }}</option> </select> <div class="invalid-feedback" *ngIf="playerForm.controls['teamId'].invalid && playerForm.controls['teamId'].touched"> Debe seleccionar un equipo. </div> </div> -->
          <!-- Estado -->
          <div class="col-md-6"> <label class="form-label">Estado *</label> <select class="form-select form-select-sm"
              formControlName="status"
              [ngClass]="{ 'is-invalid': playerForm.controls['status'].invalid && playerForm.controls['status'].touched, 'is-valid': playerForm.controls['status'].valid }">
              <option [ngValue]="null" disabled>Seleccione...</option>
              <option *ngFor="let st of estados" [ngValue]="st.valor">{{ st.etiqueta }}</option>
            </select>
            <div class="invalid-feedback"
              *ngIf="playerForm.controls['status'].invalid && playerForm.controls['status'].touched"> Debe seleccionar
              un estado. </div>
          </div>
        </div>
      </div>
      <div class="modal-footer"> <button type="button" class="btn btn-secondary btn-sm"
          (click)="closeModal()">Cancelar</button> <button type="submit" class="btn btn-primary btn-sm"
          [disabled]="playerForm.invalid || loading"> <span *ngIf="loading"
            class="spinner-border spinner-border-sm me-1"></span> Guardar </button> </div>
    </form>
  </div>
</ng-template>


<!--  Modal: Nuevo Resultado -->
<ng-template #modalResult>
  <div class="modal-content">
    <div class="modal-header bg-primary text-white py-2 px-3 d-flex justify-content-between align-items-center">
      <h2 class="modal-title flex-grow-1 m-0">
        {{ idResult ? 'Editar' : 'Registrar' }} Resultado
      </h2>
      <button type="button" class="btn-close btn-close-white ms-2" aria-label="Close" (click)="closeModal()"
        style="filter: brightness(0) invert(1);"></button>
    </div>

    <div class="modal-body">
      <form [formGroup]="resultForm" novalidate>
        <div class="row g-3">
          <div class="col-md-6">
            <label class="form-label">Categor√≠a</label>
            <select class="form-select" formControlName="categoryId">
              <option [ngValue]="null" disabled>Categor√≠a...</option>
              <option *ngFor="let category of categories" [ngValue]="category.categoryId">
                {{ category.name }}
              </option>
            </select>
          </div>

          <div class="col-md-6">
            <label class="form-label">Modalidad</label>
            <select class="form-select" formControlName="modalityId">
              <option [ngValue]="null" disabled>Modalidad...</option>
              <option *ngFor="let modality of modalities" [ngValue]="modality.modalityId">
                {{ modality.name }}
              </option>
            </select>
          </div>

          <!-- Campo de Rama -->
          <div class="col-md-6">
            <label class="form-label">Rama</label>
            <select class="form-select" formControlName="rama" [ngClass]="{
                    'is-invalid':
                      resultForm.controls['rama'].invalid &&
                      resultForm.controls['rama'].touched
                  }">
              <option [ngValue]="null" disabled>Seleccione rama...</option>
              <option value="masculino">Masculino</option>
              <option value="femenino">Femenino</option>
            </select>
          </div>

          <div class="col-md-6">
            <label class="form-label">Ronda</label>
            <select class="form-select" formControlName="roundId">
              <option [ngValue]="null" disabled>Ronda...</option>
              <option *ngFor="let round of roundNumbers" [ngValue]="round">
                {{ round }}
              </option>
            </select>
          </div>

          <div class="col-md-6">
            <label class="form-label">Jugador</label>
            <select class="form-select" formControlName="personId">
              <option [ngValue]="null" disabled>Jugador...</option>
              <option *ngFor="let person of players" [ngValue]="person.userId">
                {{ person.fullName }}
              </option>
            </select>
          </div>

          <div class="col-md-6">
            <label class="form-label">Equipo</label>
            <select class="form-select" formControlName="teamId">
              <option [ngValue]="null" disabled>Equipo...</option>
              <option *ngFor="let team of teams" [ngValue]="team.teamId">
                {{ team.nameTeam }}
              </option>
            </select>
          </div>

          <div class="col-md-6">
            <label class="form-label">Pista</label>
            <select class="form-select" formControlName="laneNumber">
              <option [ngValue]="null" disabled>Pista...</option>
              <option *ngFor="let lane of laneNumbers" [ngValue]="lane.laneNumber">
                {{ lane.laneNumber }}
              </option>
            </select>
          </div>

          <div class="col-md-6">
            <label class="form-label">L√≠nea Jugada</label>
            <select class="form-select" formControlName="lineNumber">
              <option [ngValue]="null" disabled>L√≠nea...</option>
              <option *ngFor="let line of lineNumbers" [ngValue]="line.lineNumber">
                {{ line.lineNumber }}
              </option>
            </select>
          </div>

          <div class="col-md-6">
            <label class="form-label">Puntaje</label>
            <input formControlName="score" type="number" class="form-control" placeholder="Puntaje" />
          </div>
        </div>
      </form>
    </div>

    <div class="modal-footer">
      <div class="d-flex justify-content-end gap-2">
        <button type="button" class="btn btn-outline-secondary" (click)="closeModal()">Cancelar</button>
        <button type="button" class="btn btn-success" [disabled]="resultForm.invalid"
          (click)="saveResult()">Guardar</button>
      </div>
    </div>
  </div>
</ng-template>
